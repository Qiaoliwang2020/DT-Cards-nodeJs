<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>DT Cards</title>
    <link rel='stylesheet' href='stylesheets/protected.css'/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <script src="https://code.jquery.com/jquery-3.1.1.js"></script>
<!--    <script src="jquery.json-viewer.js"></script>-->
    <link href="stylesheets/jquery.json-viewer.css" type="text/css" rel="stylesheet"/>
    <!-- Compiled and minified CSS -->
    <!-- Materialze-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">

    <!-- Materialize icons-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <link href="/styles.css" rel="stylesheet">
</head>
<body>
<div class="maindiv">
    <div class="container">
        <h1 class="page-title center">Home</h1>
        <div class="page-nav-profile">
            <div class="page-nav-user">
                <span class="user-icon center">
                  <img id="user-icon" src="/assets/icon/user.png" width="25" height="25">
               </span>
               <div class="ml-10">Hello <span id="userNameSpan" ></span></div>
            </div>
            <a href='/logout'>logout</a>
        </div>
        <div class="cards-list">

        </div>
        <div class="history-list mt-20">
            <div class="list-header"><span class="list-title">History</span> <a href="#">See all</a></div>
            <a class="history-item">
                <div class="h-item-left">
                    <img src="/assets/icon/melbourne.png" width="30" height="30">
                </div>
                <div class="h-item-right">
                    <div class="h-item-title">Flinders Street - Deakin University</div>
                    <div class="h-item-info">
                        <span class="date">15 Mar 2021</span>
                        <span class="price">-$4.50</span>
                    </div>
                </div>
            </a>
            <a class="history-item">
                <div class="h-item-left">
                    <img src="/assets/icon/melbourne.png" width="30" height="30">
                </div>
                <div class="h-item-right">
                    <div class="h-item-title">Flinders Street - Deakin University</div>
                    <div class="h-item-info">
                        <span class="date">15 Mar 2021</span>
                        <span class="price">-$4.50</span>
                    </div>
                </div>
            </a>
            <a class="history-item">
                <div class="h-item-left">
                    <img src="/assets/icon/melbourne.png" width="30" height="30">
                </div>
                <div class="h-item-right">
                    <div class="h-item-title">Flinders Street - Deakin University</div>
                    <div class="h-item-info">
                        <span class="date">15 Mar 2021</span>
                        <span class="price">-$4.50</span>
                    </div>
                </div>
            </a>
            <a class="history-item">
                <div class="h-item-left">
                    <img src="/assets/icon/melbourne.png" width="30" height="30">
                </div>
                <div class="h-item-right">
                    <div class="h-item-title">Flinders Street - Deakin University</div>
                    <div class="h-item-info">
                        <span class="date">15 Mar 2021</span>
                        <span class="price">-$4.50</span>
                    </div>
                </div>
            </a>
        </div>
        <div class="bottom-bar center">
            <a href="#modal-new-card" class="modal-trigger btn-floating btn-large waves-effect waves-light green"><i class="material-icons">add</i></a>
        </div>
        <div id="modal-new-card" class="modal bottom-sheet">
            <div class="modal-content">
                <div class="modal-close-icon modal-close">x</div>
                <h4 class="modal-title">Get a new card</h4>
                <div>
                    <label>Which City’s transport card you want to apply for?</label>
                    <div class="mt-10">
                        <select id="country" class="select-css mb-10">
                            <option value="" disabled selected>Select a country</option>
                        </select>
                        <select id="state" class="select-css mb-10">
                            <option value="" disabled selected>Select a state</option>
                        </select>
                        <select id="city" class="select-css mb-10">
                            <option value="" disabled selected>Select a city</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="mb-20">Are you a resident?</label>
                    <div class="mt-10 mb-10" id="resident">
                        <label>
                            <input name="resident" type="radio" value="Yes" />
                            <span>Yes</span>
                        </label>
                        <label class="ml-20">
                            <input name="resident" type="radio" value="No" />
                            <span>No</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label>Card Holder’s name</label>
                    <div class="mt-10"><input  type="text" id="cardHolderName" onblur="invalidValues({cardHolderName:this.value})"  /></div>
                </div>
                <div>
                    <label class="mb-20">Gender</label>
                    <div class="mt-10 mb-10" id="gender">
                        <label>
                            <input name="gender" type="radio" value="female" />
                            <span>female</span>
                        </label>
                        <label class="ml-20">
                            <input name="gender" type="radio" value="male" />
                            <span>male</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label class="mb-20">Birthday</label>
                    <input type="text" id="birthday" onblur="invalidValues({birthday:this.value})"  class="datepicker mt-10">
                </div>
                <div>
                    <label class="mb-20">Current Address</label>
                    <div class="mt-10"><input  type="text" id="address" onblur="invalidValues({address:this.value})" /></div>
                </div>
                <div>
                    <label class="mb-20">Email</label>
                    <div class="mt-10"><input  type="text" id="email" onblur="invalidValues({email:this.value})"/></div>
                </div>
                <div>
                    <label class="mb-20">Phone</label>
                    <div class="mt-10"><input  type="number" id="phone"onblur="invalidValues({phone:this.value})"/></div>
                </div>
            </div>
            <div class="modal-footer">
                <a class="button-primary" id="submit">Submit</a>
            </div>
        </div>
    </div>
<!--    <div class="bottom-container">-->
<!--        <div class="bottom-container-data">-->
<!--            <div class="token-title">-->
<!--                ID Token-->
<!--            </div>-->
<!--            <div id="idTokenPayload" class="token-info"></div>-->
<!--        </div>-->
<!--    </div>-->
</div>
<!-- Compiled and minified JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script>
    $(document).ready(function() {

        $('#modal-new-card').modal();
        $('.datepicker').datepicker();

        getCards();
        getCities();

        $('#submit').click(function (){
           let data={
               userId:$('#userNameSpan').data('userid'),
               city:$('#city').val() ? $('#city').val() : $('#state').val(),
               resident:$("input[name='resident']:checked").val(),
               cardHolderName:$('#cardHolderName').val(),
               gender:$("input[name='gender']:checked").val(),
               birthday:$('#birthday').val(),
               address:$('#address').val(),
               email:$('#email').val(),
               phone:$('#phone').val(),
            }
            let invalid = invalidValues(data);

            if(!invalid){
                $.post( "/cards/createCard",data,(result) =>{
                    $('#modal-new-card').modal('close');
                    if(result === 'success'){
                        location.reload();
                    }
                });
            }
        })
    })
   invalidValues = (data)=>{
        $('.invalid-text').remove();
        let errs = Object.keys(data).filter(function(key, index) {
            return data[key] == '' || data[key] == undefined
        });

        if (errs.length > 0){
            errs.forEach(((item)=>{
                $(`#${item}`).addClass('invalid');
                $(`#${item}`).after(`<div class="invalid-text" style="color: red">${item} is required</div>`)
            }))
        }else{
            let labelName = Object.keys(data)[0];
            $(`#${labelName}`).removeClass('invalid');
            $(`#${labelName}`).siblings('.invalid-text').remove();
            errs = null;
        }
        return errs;
    }
    getCards =()=>{
        $.get("/cards",(result)=>{
            $('.cards-list').empty();
            if(result.length > 0){
                result.forEach((item)=>{
                    let cards = `<a href="/card?id=${item._id}" class="card-item" style="background: ${item.cardBackground};">
                            <div class="card-left">
                                <div class="card-label">Balance</div>
                                <div class="card-amount">${item.balance}</div>
                            </div>
                            <div class="card-right text-right">
                           <span class="card-icon">
                                <img src="/assets/icon/public-transport.png" width="35" height="35">
                            </span>
                                <div class="card-location">${item.city}<i class="small material-icons">chevron_right</i></div>
                            </div>
                        </a>`
                    $('.cards-list').append(cards);
                })
            }
        })
    }
    getCities =()=>{
        let token = '';
        $.ajax({
            type: "GET",
            url: "https://www.universal-tutorial.com/api/getaccesstoken",
            headers: {
                "Accept": "application/json",
                "api-token": "cCH-SC8Fyg0uhdhomktrI0aIarIEtvc2hUaqrVmgiU8sUzBfNUplqafVXjnaPQEQ4Ig",
                "user-email": "414217795zoe@gmail.com"
            },
            success: function(msg) {
                token = msg.auth_token;
                console.log(msg.auth_token,'token');
                $.ajax({
                    type: "GET",
                    url: "https://www.universal-tutorial.com/api/countries/",
                    headers:{
                        "Authorization": `Bearer ${token}`,
                        "Accept": "application/json"
                    },
                    success: function(res) {
                        $('#country').empty();
                        let country = res.map(item=>{
                            return item.country_name
                        })
                        $('#country').append(`<option value="" disabled selected>Select a country</option>`);
                        country.forEach((item)=>{
                            console.log(item);
                            $('#country').append(`<option value='${item}'>${item}</option>`)
                        })
                    }
                });
            }
        });

        $('#country').on('change', function() {
            $.ajax({
                type: "GET",
                headers:{
                    "Authorization": `Bearer ${token}`,
                    "Accept": "application/json"
                },
                url: `https://www.universal-tutorial.com/api/states/${this.value}`,
                success: function(res) {
                    $('#state').empty();
                    let states = res.map((item)=>{
                        return item.state_name;
                    })
                    $('#state').append(`<option value="" disabled selected>Select a state</option>`);
                    states.forEach((item)=>{
                        console.log(item);
                        $('#state').append(`<option value='${item}'>${item}</option>`)
                    })
                    console.log(states);
                }
            });

        });
        $('#state').on('change', function() {
            $.ajax({
                type: "GET",
                headers:{
                    "Authorization": `Bearer ${token}`,
                    "Accept": "application/json"
                },
                url: `https://www.universal-tutorial.com/api/cities/${this.value}`,
                success: function(res) {
                    $('#city').empty();
                    let cities = res.map((item)=>{
                        return item.city_name;
                    })
                    $('#city').append(`<option value="" disabled selected>Select a city</option>`);
                    cities.forEach((item)=>{
                        console.log(item);
                        $('#city').append(`<option value='${item}'>${item}</option>`)
                    })
                }
            });
        });
    }
	$.getJSON('/home/api/idPayload', function (id_token) {
		$('#userNameSpan').html(id_token.name);
        $('#userNameSpan').attr('data-userid',id_token.sub);
		$('#user-icon').attr('src',id_token.picture);
		$('#cardHolderName').val(id_token.name)
		$('#email').val(id_token.email);
		// $('#idTokenPayload').jsonViewer(id_token, {collapsed: false});
	});
</script>

</body>
</html>
